# GitHub Pages 部署工作流程图

本文档展示了完整的部署工作流程和架构。

## 🔄 自动部署流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        开发者本地环境                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 编写代码                                                      │
│     ├── 修改 src/ 文件                                           │
│     ├── 更新样式和内容                                            │
│     └── 测试: pnpm dev                                           │
│                                                                 │
│  2. 本地构建测试                                                  │
│     └── pnpm build                                              │
│                                                                 │
│  3. 提交和推送                                                    │
│     ├── git add .                                               │
│     ├── git commit -m "..."                                     │
│     └── git push origin main                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ git push
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                         GitHub 仓库                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  • 接收推送                                                       │
│  • 触发 GitHub Actions 工作流                                    │
│  • 存储代码历史                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 触发工作流
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Actions Runner                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔨 构建阶段 (Build Job)                                         │
│  ├─────────────────────────────────────────────────────────┐   │
│  │  1. Checkout 代码                                        │   │
│  │     └── actions/checkout@v4                             │   │
│  │                                                          │   │
│  │  2. 设置 Node.js 环境                                    │   │
│  │     ├── actions/setup-node@v4                           │   │
│  │     └── Node.js 20                                      │   │
│  │                                                          │   │
│  │  3. 设置 pnpm                                            │   │
│  │     ├── pnpm/action-setup@v4                            │   │
│  │     └── pnpm 10.11.0                                    │   │
│  │                                                          │   │
│  │  4. 缓存依赖                                              │   │
│  │     ├── actions/cache@v4                                │   │
│  │     └── 缓存 pnpm store                                  │   │
│  │                                                          │   │
│  │  5. 安装依赖                                              │   │
│  │     └── pnpm install --frozen-lockfile                  │   │
│  │                                                          │   │
│  │  6. 构建项目                                              │   │
│  │     ├── pnpm build                                       │   │
│  │     ├── Next.js 编译                                     │   │
│  │     ├── 静态生成页面                                      │   │
│  │     └── 输出到 out/ 目录                                  │   │
│  │                                                          │   │
│  │  7. 上传构建产物                                           │   │
│  │     └── actions/upload-pages-artifact@v3                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            │                                    │
│                            │ artifact                           │
│                            ▼                                    │
│  🚀 部署阶段 (Deploy Job)                                        │
│  ├─────────────────────────────────────────────────────────┐   │
│  │  1. 下载构建产物                                           │   │
│  │     └── 从 Build Job 获取 artifact                       │   │
│  │                                                          │   │
│  │  2. 部署到 GitHub Pages                                  │   │
│  │     └── actions/deploy-pages@v4                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 部署完成
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                       GitHub Pages CDN                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  • 全球 CDN 分发                                                 │
│  • HTTPS 加密                                                   │
│  • 自动缓存                                                      │
│  • 提供静态文件                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 访问
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                          终端用户                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🌐 访问网站                                                     │
│     └── https://username.github.io/immortalityfactory/         │
│                                                                 │
│  📱 多设备支持                                                   │
│     ├── 桌面浏览器                                               │
│     ├── 移动设备                                                 │
│     └── 平板电脑                                                 │
│                                                                 │
│  🌍 多语言访问                                                   │
│     ├── 英文: /                                                 │
│     └── 中文: /zh                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 📂 构建输出结构

```
out/
├── _next/                          # Next.js 资源
│   ├── static/
│   │   ├── chunks/                 # JavaScript 分块
│   │   │   ├── app/               # 应用代码
│   │   │   └── pages/             # 页面代码
│   │   ├── css/                   # 样式文件
│   │   └── media/                 # 字体和媒体
│   └── [build-id]/
│       ├── _buildManifest.js
│       └── _ssgManifest.js
│
├── en/                            # 英文页面
│   ├── index.html                 # 英文主页
│   └── index.txt                  # 页面元数据
│
├── zh/                            # 中文页面
│   ├── index.html                 # 中文主页
│   └── index.txt                  # 页面元数据
│
├── fonts/                         # 字体文件 (public 复制)
│
├── screenshots/                   # 截图 (public 复制)
│   ├── factory-layout.png
│   └── recipe-book.png
│
├── index.html                     # 根页面 (英文)
├── index.txt                      # 根页面元数据
├── 404.html                       # 404 错误页面
├── game.html                      # 游戏文件
└── (其他 public/ 文件)
```

## 🔀 路由映射

### URL 到文件的映射:

```
用户访问的 URL              →  实际文件路径
─────────────────────────────────────────────────────────
/                           →  /index.html
/en                         →  /en/index.html
/zh                         →  /zh/index.html
/game.html                  →  /game.html
/screenshots/...            →  /screenshots/...
/404                        →  /404.html
/_next/static/...           →  /_next/static/...
```

### 语言检测流程:

```
用户访问
  │
  ├─ 访问 /
  │   └─> 显示英文主页 (默认)
  │
  ├─ 访问 /zh
  │   └─> 显示中文主页
  │
  └─ 访问 /en
      └─> 显示英文主页
```

## ⚙️ 配置文件关系

```
next.config.js
  ├── output: 'export'              → 启用静态导出
  ├── images.unoptimized: true      → 图片不优化 (静态要求)
  └── trailingSlash: true           → URL 尾部加斜杠

              ↓ 影响

构建过程 (next build)
  ├── 生成静态 HTML
  ├── 预渲染所有路由
  ├── 优化资源
  └── 输出到 out/

              ↓ 结果

out/ 目录
  └── 完全静态的网站
      ├── 所有 HTML 已生成
      ├── 所有资源已优化
      └── 可部署到任何静态主机
```

## 🔄 缓存策略

### GitHub Actions 缓存:

```
pnpm-lock.yaml
  │ (作为缓存键)
  ▼
缓存 pnpm store
  ├── 首次运行: 下载所有依赖 (~2-3 分钟)
  └── 后续运行: 使用缓存 (~30 秒)
```

### 浏览器缓存:

```
GitHub Pages CDN
  ├── HTML 文件: 缓存 10 分钟
  ├── 静态资源 (_next/static/...): 缓存 1 年
  │   └── 文件名包含哈希,变更时自动失效
  └── 其他资源: 缓存 24 小时
```

## 🚦 部署时间线

```
时间轴:
  0:00  ─  git push 推送代码
  0:05  ─  GitHub Actions 开始运行
  0:10  ─  安装依赖 (首次) 或使用缓存 (~30 秒)
  0:30  ─  构建项目 (pnpm build)
  1:30  ─  上传构建产物
  2:00  ─  开始部署到 GitHub Pages
  2:30  ─  部署完成
  3:00  ─  CDN 分发 (可能需要几分钟)
  5:00  ─  全球可访问 ✅

总时间: ~3-5 分钟 (有缓存时可减少到 2-3 分钟)
```

## 🌍 全球访问流程

```
                          GitHub Pages CDN
                                 │
           ┌─────────────────────┼─────────────────────┐
           │                     │                     │
      北美节点                亚洲节点               欧洲节点
           │                     │                     │
     美国用户访问            中国香港用户访问        德国用户访问
           │                     │                     │
           └─────────────────────┴─────────────────────┘
                       自动选择最近的 CDN 节点
```

## 🔐 安全和权限

### GitHub Actions 权限:

```
GITHUB_TOKEN (自动生成)
  ├── contents: read      → 读取仓库代码
  ├── pages: write        → 写入 GitHub Pages
  └── id-token: write     → 身份验证
```

### 部署环境:

```
github-pages 环境
  ├── 需要审批: 否
  ├── 分支限制: main
  └── URL: https://username.github.io/repo
```

## 🔍 监控和日志

### 查看部署状态:

```
GitHub 仓库
  │
  ├─ Actions 标签页
  │   ├── 所有工作流运行历史
  │   ├── 运行状态 (成功/失败)
  │   └── 详细日志
  │
  ├─ Settings → Pages
  │   ├── 当前部署 URL
  │   ├── 构建来源
  │   └── 自定义域名
  │
  └─ Environments → github-pages
      ├── 最近部署
      ├── 部署历史
      └── 环境 URL
```

### 日志结构:

```
工作流运行
  │
  ├─ Build Job
  │   ├─ Checkout
  │   ├─ Setup Node.js
  │   ├─ Setup pnpm
  │   ├─ Install dependencies
  │   ├─ Build (详细构建日志)
  │   └─ Upload artifact
  │
  └─ Deploy Job
      ├─ Download artifact
      └─ Deploy to Pages
```

## 🎯 多环境部署策略

### 当前配置 (单环境):

```
main 分支 → GitHub Pages (生产环境)
```

### 推荐的多环境配置:

```
develop 分支 → Vercel/Netlify (开发环境)
     ↓
staging 分支 → Vercel/Netlify (预发布环境)
     ↓
main 分支 → GitHub Pages (生产环境)
```

## 📊 性能指标

### 构建性能:

```
项目大小: ~25 MB
依赖数量: ~30 个包
构建时间: ~30-60 秒
输出大小: ~15 MB (out/ 目录)
```

### 运行时性能:

```
首次加载 JS: ~130 KB (gzip)
页面大小: ~15 KB (HTML)
字体文件: ~100 KB
总体评分: Lighthouse 95+
```

## 🔄 回滚策略

### 方法 1: Git Revert

```
发现问题
  │
  ├─ git revert HEAD
  ├─ git push
  └─ 自动重新部署 (2-3 分钟)
```

### 方法 2: 重新部署旧版本

```
查看历史
  │
  ├─ git log --oneline
  ├─ git checkout <commit-hash>
  ├─ git push -f origin main  (谨慎!)
  └─ 自动重新部署
```

### 方法 3: GitHub Pages 设置

```
Settings → Pages
  │
  └─ 手动选择之前的部署
```

## 📈 扩展和优化

### 当前架构限制:

- ❌ 无服务器端逻辑
- ❌ 无动态路由
- ❌ 无 API 路由
- ❌ 无实时数据

### 可能的扩展:

1. **添加 API 层**
   - 使用 Vercel Functions
   - 或 Firebase Functions

2. **添加数据库**
   - Supabase
   - Firebase
   - PlanetScale

3. **添加实时功能**
   - WebSocket
   - Server-Sent Events

4. **添加认证**
   - NextAuth.js
   - Clerk
   - Supabase Auth

## 🎉 总结

这个部署工作流实现了:

✅ 完全自动化的 CI/CD
✅ 零配置的 CDN 分发
✅ 免费的 HTTPS 支持
✅ 全球高可用性
✅ 简单的回滚机制
✅ 清晰的监控和日志

**下一步**: 推送代码,让魔法发生! 🚀

